# pediatric-mNGS-LRTI-classifier
This repo houses data and code for the analyses in the pre-print ["Leveraging the pulmonary immune response and microbiome for improved lower respiratory tract infection diagnosis in critically ill children"](https://doi.org/10.1101/2022.12.01.22282994), focused on development and validation of a classifier for lower respiratory tract infection (LRTI) in critically ill children using host and microbial features from metagenomic next generation sequencing (mNGS) of tracheal aspirate RNA.

## How to get started
1. Download the repo to your local system.
2. Change the `project_root` variable in the script `constants.R` to the path of the main repo folder on your local system.
3. Set the R working directory to the `code` folder in the repo.
4. Run the numbered scripts in the `code` folder in order.

## Raw data

1. `sample_metadata.csv` details all patient (n=261) and water (n=32) samples used in this study including (where applicable) their age, sex, clinical LRTI adjudication, sequencing batch and total nonhost counts from the [CZ-ID](http://czid.org) metagenomic analysis pipeline.
2. `host_gene_counts.csv` includes the raw (unfiltered, unnormalized) host (human) gene counts of all patient samples. The counts were generated by pseudo-alignment with kallisto followed by summarization to the gene level with tximport. Genes are identified by their ENSEMBL ID. See the publication Methods section for full details. These gene counts are also deposited in the NCBI Gene Expression Omnibus (GEO) database under accession [GSE212532](https://www.ncbi.nlm.nih.gov/geo/query/acc.cgi?acc=GSE212532).
3. `microbe_reports.csv` is the nonhost taxa counts table of all the samples as generated by the CZ-ID pipeline. 
4. `known_respiratory_pathogens.csv` is a curated list of organisms with known potential to cause LRTI.

## Scripts

1. `01-generate_cv_folds.R` - Randomly splits the samples with "Definite" or "No Evidence" LRTI status into 5 folds for cross-validation.
2. `02-filter_transform_host_counts_for_cv.R` - Filters the host counts for the cross-validation samples and applies the variance stablizing transformation as implemented in DESeq2.
3. `03-host_lasso_cv.R` - Selects features (genes) for use in a host-based LRTI classifier for each train/test split, as well as for all the Definite/No Evidence samples, using lasso logistic regression.
4. `04-host_lassoRF_cv.R` - Trains a random forest classifier on the training samples and with the selected genes of each train/test split.
5. `05-microbe_background_filtering.R` - Generates background filtering statistics on the microbial taxa using a negative binomial model trained on the water samples, as implemented in `idseqr.R`. [idseqr](https://github.com/czbiohub/idseqr) is a package for working with output from the CZ-ID pipeline in R that is currently in alpha stage.
6. `06-microbe_viral_hits_and_RBM.R` - outputs i) likely pathogenic viral taxa present in patient samples after background filtering, and ii) microbial/fungal taxa identified by a rules-based model (RBM) as potential pathogens.

## Viral calls

Viral calls in each sample are generated by the script `code/viral_calls-1.R` based on the results of the [IDSeq](http://www.idseq.net) metagenomic analysis pipeline. The script creates `results/viral_calls/viruses_with_pval.csv`, a table
of viral read counts along with p-values for whether the virus is present above background
levels according to a negative binomial model trained on control samples. The second script
`code/viral_calls-2.R` then aggregates these results across all samples and combines them with
the metadata table to create `data/metatable_with_viral_status.csv`, as described above.

The `code/viral_calls-1.R` script relies on code from the package
[idseqr](https://github.com/czbiohub/idseqr) which is currently in
alpha stage. The specific version of that package used for the
analysis is included as a git submodule at `code/idseqr`.

The script expects the metagenomic count data that IDSeq outputs to reside in
`data/viral_calls/sample_taxon_reports`, but this data is not included in
the repo due to size limitations. To download the data, register for a
free account on [IDSeq](http://www.idseq.net), then download the "Sample Taxon
Reports" for the project
`covid19_transcriptomics_pathogenesis_diagnostics`. The Download will
prompt you to select a "Background" but it doesn't affect any of the
variables we use so you can select any background (e.g., "NID Human
CSF"). Unzip the reports and then move them into
`data/viral_calls/sample_taxon_reports`. The metadata table described above includes the IDSeq sample name associated with each sample identifier (CZB_ID).

## Gene counts table

Transcript quantification was performed with kallisto (v. 0.46.1, with bias correction) against an index consisting of transcripts of protein coding genes (ENSEMBL v. 99), cytosolic and mitochondrial ribosomal RNA sequences and ERCC RNA standards.<br><br>
Aggregation to the gene level was done with tximport using countsFromAbundance="lengthScaledTPM". The mapping from transcript ID to gene ID is in `annotations/tx2gene.txt`. Genes were retained for analysis if they had at least 10 counts in at least 20% of the samples in the dataset. The counts for those gene are in `data/swab_gene_counts.csv`. Note, gene counts in the table were not normalized further. Genes in the table are identified by their ENSEMBL ID. The mapping to gene symbol and chromosome is in `annotations/gene2name.txt`.

## DE analysis

Pairwise DE analyses between the three patient groups using the model ~viral_status + age + gender, as well as regression of gene counts against viral abundance (rpM) for the differentially expressed genes, are performed in `code/DE_analysis.R`. Results are in `results/DE`. 

## Classifier analysis

- `classifier-1-generate-cv-folds.R` generates the
  cross-validation folds.
- `classifier-2-fit-models.R` fits the classifier models.
  Results are stored in `results/classifier`.
- `classifier-3-aggregate-results.py` and
  `classifier-4-sensitivity-specifity.R` aggregate results and put
  them in `figures/classifier`.

## Deconvolution analysis
We used the Human Lung Cell Atlas dataset [Travaglini et al. (bioRxiv 2019)](https://www.biorxiv.org/content/10.1101/742320v1) to generate the single cell signature files used as the basis for the deconvolution analysis in [CiberSortX](https://www.nature.com/articles/s41587-019-0114-2).

Cell deconvolution analysis is in `code/host_deconvolution.ipynb`,
with results in `results/deconvolution`.

## Changes from the pre-print version
The main difference from the pre-print version is the exclusion of 4 of the original 238 samples from all of the analyses because their group label was ambiguous. These samples are still available in the IDSeq reports and the raw sequencing data we deposited online. In addition, minor changes were made in the DE analysis as detailed in the peer review file accompanying the publication. 
